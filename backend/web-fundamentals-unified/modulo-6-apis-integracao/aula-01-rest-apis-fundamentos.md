# üåê Aula 1: REST APIs - Fundamentos
## Web Fundamentals - M√≥dulo 6: APIs e Integra√ß√£o

‚è±Ô∏è **Dura√ß√£o**: 90 min  
üéØ **Objetivos**: 8  
üß™ **Exerc√≠cios**: 4  
üìö **N√≠vel**: Intermedi√°rio  

---

## üéØ Objetivos de Aprendizado

- ‚úÖ Dominar arquitetura REST
- ‚úÖ Implementar m√©todos HTTP corretos
- ‚úÖ Designar endpoints eficientes
- ‚úÖ Aplicar versionamento de APIs
- ‚úÖ Documentar com OpenAPI
- ‚úÖ Implementar testes de APIs
- ‚úÖ Configurar middleware
- ‚úÖ Aplicar boas pr√°ticas

---

## üìö Conte√∫do Principal

### 1. üåü Fundamentos da Arquitetura REST

#### **O que √© REST?**
```javascript
// REST (Representational State Transfer) √© um estilo arquitetural
// Baseado em princ√≠pios de simplicidade e escalabilidade
// Usa HTTP como protocolo de comunica√ß√£o
// Stateless e cacheable

// Princ√≠pios REST:
// 1. Stateless - cada requisi√ß√£o √© independente
// 2. Client-Server - separa√ß√£o de responsabilidades
// 3. Cacheable - respostas podem ser cacheadas
// 4. Uniform Interface - interface consistente
// 5. Layered System - arquitetura em camadas
// 6. Code on Demand - c√≥digo opcional

// Exemplo de estrutura REST
const express = require('express');
const app = express();

// Middleware para parsing JSON
app.use(express.json());

// Endpoints RESTful
app.get('/api/users', (req, res) => {
  // GET - Listar usu√°rios
});

app.get('/api/users/:id', (req, res) => {
  // GET - Obter usu√°rio espec√≠fico
});

app.post('/api/users', (req, res) => {
  // POST - Criar novo usu√°rio
});

app.put('/api/users/:id', (req, res) => {
  // PUT - Atualizar usu√°rio completo
});

app.patch('/api/users/:id', (req, res) => {
  // PATCH - Atualizar usu√°rio parcialmente
});

app.delete('/api/users/:id', (req, res) => {
  // DELETE - Remover usu√°rio
});
```

#### **Estrutura de Projeto**
```bash
# Estrutura de projeto REST API
api-project/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ userController.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ productController.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ orderController.js
‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ User.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Product.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Order.js
‚îÇ   ‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ userRoutes.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ productRoutes.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ orderRoutes.js
‚îÇ   ‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ validation.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ errorHandler.js
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ userService.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ productService.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ orderService.js
‚îÇ   ‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logger.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ helpers.js
‚îÇ   ‚îî‚îÄ‚îÄ app.js
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îî‚îÄ‚îÄ e2e/
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îî‚îÄ‚îÄ api.md
‚îî‚îÄ‚îÄ package.json
```

### 2. üîÑ M√©todos HTTP e Status Codes

#### **M√©todos HTTP**
```javascript
// GET - Recuperar dados
app.get('/api/users', async (req, res) => {
  try {
    const users = await userService.getAllUsers();
    res.status(200).json({
      success: true,
      data: users,
      count: users.length
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      message: 'Erro interno do servidor',
      error: error.message
    });
  }
});

// POST - Criar novo recurso
app.post('/api/users', async (req, res) => {
  try {
    const { name, email, password } = req.body;
    
    // Valida√ß√£o
    if (!name || !email || !password) {
      return res.status(400).json({
        success: false,
        message: 'Nome, email e senha s√£o obrigat√≥rios'
      });
    }
    
    const user = await userService.createUser({ name, email, password });
    
    res.status(201).json({
      success: true,
      data: user,
      message: 'Usu√°rio criado com sucesso'
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      message: 'Erro ao criar usu√°rio',
      error: error.message
    });
  }
});

// PUT - Atualizar recurso completo
app.put('/api/users/:id', async (req, res) => {
  try {
    const { id } = req.params;
    const { name, email, password } = req.body;
    
    const user = await userService.updateUser(id, { name, email, password });
    
    if (!user) {
      return res.status(404).json({
        success: false,
        message: 'Usu√°rio n√£o encontrado'
      });
    }
    
    res.status(200).json({
      success: true,
      data: user,
      message: 'Usu√°rio atualizado com sucesso'
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      message: 'Erro ao atualizar usu√°rio',
      error: error.message
    });
  }
});

// PATCH - Atualizar recurso parcialmente
app.patch('/api/users/:id', async (req, res) => {
  try {
    const { id } = req.params;
    const updates = req.body;
    
    const user = await userService.updateUserPartial(id, updates);
    
    if (!user) {
      return res.status(404).json({
        success: false,
        message: 'Usu√°rio n√£o encontrado'
      });
    }
    
    res.status(200).json({
      success: true,
      data: user,
      message: 'Usu√°rio atualizado com sucesso'
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      message: 'Erro ao atualizar usu√°rio',
      error: error.message
    });
  }
});

// DELETE - Remover recurso
app.delete('/api/users/:id', async (req, res) => {
  try {
    const { id } = req.params;
    
    const deleted = await userService.deleteUser(id);
    
    if (!deleted) {
      return res.status(404).json({
        success: false,
        message: 'Usu√°rio n√£o encontrado'
      });
    }
    
    res.status(200).json({
      success: true,
      message: 'Usu√°rio removido com sucesso'
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      message: 'Erro ao remover usu√°rio',
      error: error.message
    });
  }
});
```

#### **Status Codes**
```javascript
// Status Codes HTTP
const statusCodes = {
  // 2xx - Sucesso
  200: 'OK',                    // Requisi√ß√£o bem-sucedida
  201: 'Created',               // Recurso criado com sucesso
  202: 'Accepted',              // Requisi√ß√£o aceita para processamento
  204: 'No Content',            // Sucesso sem conte√∫do de retorno
  
  // 3xx - Redirecionamento
  301: 'Moved Permanently',     // Recurso movido permanentemente
  302: 'Found',                 // Recurso encontrado temporariamente
  304: 'Not Modified',          // Recurso n√£o modificado
  
  // 4xx - Erro do Cliente
  400: 'Bad Request',           // Requisi√ß√£o inv√°lida
  401: 'Unauthorized',          // N√£o autorizado
  403: 'Forbidden',             // Acesso negado
  404: 'Not Found',             // Recurso n√£o encontrado
  409: 'Conflict',              // Conflito de recursos
  422: 'Unprocessable Entity',  // Entidade n√£o process√°vel
  429: 'Too Many Requests',     // Muitas requisi√ß√µes
  
  // 5xx - Erro do Servidor
  500: 'Internal Server Error', // Erro interno do servidor
  502: 'Bad Gateway',           // Gateway inv√°lido
  503: 'Service Unavailable',   // Servi√ßo indispon√≠vel
  504: 'Gateway Timeout'        // Timeout do gateway
};

// Exemplo de uso de status codes
app.get('/api/users/:id', async (req, res) => {
  try {
    const { id } = req.params;
    
    // Valida√ß√£o de ID
    if (!id || isNaN(id)) {
      return res.status(400).json({
        success: false,
        message: 'ID inv√°lido'
      });
    }
    
    const user = await userService.getUserById(id);
    
    if (!user) {
      return res.status(404).json({
        success: false,
        message: 'Usu√°rio n√£o encontrado'
      });
    }
    
    res.status(200).json({
      success: true,
      data: user
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      message: 'Erro interno do servidor',
      error: error.message
    });
  }
});
```

### 3. üéØ Design de Endpoints

#### **Nomenclatura e Estrutura**
```javascript
// Boas pr√°ticas para design de endpoints

// 1. Use substantivos, n√£o verbos
// ‚ùå Ruim
app.get('/api/getUsers', ...);
app.post('/api/createUser', ...);

// ‚úÖ Bom
app.get('/api/users', ...);
app.post('/api/users', ...);

// 2. Use plural para recursos
// ‚ùå Ruim
app.get('/api/user', ...);
app.get('/api/product', ...);

// ‚úÖ Bom
app.get('/api/users', ...);
app.get('/api/products', ...);

// 3. Use hierarquia para relacionamentos
// ‚úÖ Bom
app.get('/api/users/:userId/orders', ...);
app.get('/api/users/:userId/orders/:orderId', ...);
app.get('/api/users/:userId/orders/:orderId/items', ...);

// 4. Use query parameters para filtros e pagina√ß√£o
// ‚úÖ Bom
app.get('/api/users?page=1&limit=10&sort=name&order=asc', ...);
app.get('/api/products?category=electronics&price_min=100&price_max=500', ...);

// 5. Use versionamento na URL
// ‚úÖ Bom
app.get('/api/v1/users', ...);
app.get('/api/v2/users', ...);
```

#### **Implementa√ß√£o de Endpoints**
```javascript
// userRoutes.js
const express = require('express');
const router = express.Router();
const userController = require('../controllers/userController');
const authMiddleware = require('../middleware/auth');
const validationMiddleware = require('../middleware/validation');

// Middleware de autentica√ß√£o para todas as rotas
router.use(authMiddleware);

// GET /api/v1/users - Listar usu√°rios com pagina√ß√£o e filtros
router.get('/', 
  validationMiddleware.validateQuery,
  userController.getUsers
);

// GET /api/v1/users/:id - Obter usu√°rio espec√≠fico
router.get('/:id',
  validationMiddleware.validateId,
  userController.getUserById
);

// POST /api/v1/users - Criar novo usu√°rio
router.post('/',
  validationMiddleware.validateUser,
  userController.createUser
);

// PUT /api/v1/users/:id - Atualizar usu√°rio completo
router.put('/:id',
  validationMiddleware.validateId,
  validationMiddleware.validateUser,
  userController.updateUser
);

// PATCH /api/v1/users/:id - Atualizar usu√°rio parcialmente
router.patch('/:id',
  validationMiddleware.validateId,
  validationMiddleware.validateUserPartial,
  userController.updateUserPartial
);

// DELETE /api/v1/users/:id - Remover usu√°rio
router.delete('/:id',
  validationMiddleware.validateId,
  userController.deleteUser
);

// GET /api/v1/users/:id/orders - Obter pedidos do usu√°rio
router.get('/:id/orders',
  validationMiddleware.validateId,
  userController.getUserOrders
);

module.exports = router;
```

### 4. üìù Versionamento de APIs

#### **Estrat√©gias de Versionamento**
```javascript
// 1. Versionamento na URL (mais comum)
app.use('/api/v1', v1Routes);
app.use('/api/v2', v2Routes);

// 2. Versionamento no header
app.use((req, res, next) => {
  const version = req.headers['api-version'] || 'v1';
  req.apiVersion = version;
  next();
});

// 3. Versionamento por query parameter
app.use((req, res, next) => {
  const version = req.query.version || 'v1';
  req.apiVersion = version;
  next();
});

// Exemplo de implementa√ß√£o
// routes/v1/userRoutes.js
const express = require('express');
const router = express.Router();

router.get('/users', (req, res) => {
  res.json({
    version: 'v1',
    data: users,
    message: 'API v1 - Formato antigo'
  });
});

// routes/v2/userRoutes.js
const express = require('express');
const router = express.Router();

router.get('/users', (req, res) => {
  res.json({
    version: 'v2',
    data: users,
    metadata: {
      total: users.length,
      page: 1,
      limit: 10
    },
    message: 'API v2 - Formato melhorado'
  });
});

// app.js
const v1Routes = require('./routes/v1');
const v2Routes = require('./routes/v2');

app.use('/api/v1', v1Routes);
app.use('/api/v2', v2Routes);
```

#### **Migra√ß√£o de Vers√µes**
```javascript
// Estrat√©gia de migra√ß√£o
class ApiVersionManager {
  constructor() {
    this.versions = {
      v1: {
        supported: true,
        deprecated: false,
        sunsetDate: null
      },
      v2: {
        supported: true,
        deprecated: false,
        sunsetDate: null
      }
    };
  }
  
  // Verificar se vers√£o √© suportada
  isVersionSupported(version) {
    return this.versions[version]?.supported || false;
  }
  
  // Verificar se vers√£o est√° depreciada
  isVersionDeprecated(version) {
    return this.versions[version]?.deprecated || false;
  }
  
  // Obter informa√ß√µes da vers√£o
  getVersionInfo(version) {
    return this.versions[version] || null;
  }
  
  // Depreciar vers√£o
  deprecateVersion(version, sunsetDate) {
    if (this.versions[version]) {
      this.versions[version].deprecated = true;
      this.versions[version].sunsetDate = sunsetDate;
    }
  }
}

// Middleware de versionamento
const versionManager = new ApiVersionManager();

const versionMiddleware = (req, res, next) => {
  const version = req.params.version || req.headers['api-version'] || 'v1';
  
  if (!versionManager.isVersionSupported(version)) {
    return res.status(400).json({
      success: false,
      message: `Vers√£o ${version} n√£o √© suportada`,
      supportedVersions: Object.keys(versionManager.versions)
    });
  }
  
  if (versionManager.isVersionDeprecated(version)) {
    const versionInfo = versionManager.getVersionInfo(version);
    res.set('Deprecation', 'true');
    res.set('Sunset', versionInfo.sunsetDate);
    res.set('Warning', `Vers√£o ${version} est√° depreciada. Use vers√£o mais recente.`);
  }
  
  req.apiVersion = version;
  next();
};
```

### 5. üìö Documenta√ß√£o com OpenAPI

#### **Configura√ß√£o do Swagger**
```bash
# Instala√ß√£o
npm install swagger-jsdoc swagger-ui-express

# Configura√ß√£o
```

```javascript
// swagger.js
const swaggerJsdoc = require('swagger-jsdoc');
const swaggerUi = require('swagger-ui-express');

const options = {
  definition: {
    openapi: '3.0.0',
    info: {
      title: 'API de Usu√°rios',
      version: '1.0.0',
      description: 'API REST para gerenciamento de usu√°rios',
      contact: {
        name: 'Equipe de Desenvolvimento',
        email: 'dev@exemplo.com'
      }
    },
    servers: [
      {
        url: 'http://localhost:3000/api/v1',
        description: 'Servidor de desenvolvimento'
      },
      {
        url: 'https://api.exemplo.com/v1',
        description: 'Servidor de produ√ß√£o'
      }
    ],
    components: {
      securitySchemes: {
        bearerAuth: {
          type: 'http',
          scheme: 'bearer',
          bearerFormat: 'JWT'
        }
      },
      schemas: {
        User: {
          type: 'object',
          required: ['name', 'email'],
          properties: {
            id: {
              type: 'integer',
              description: 'ID √∫nico do usu√°rio'
            },
            name: {
              type: 'string',
              description: 'Nome do usu√°rio'
            },
            email: {
              type: 'string',
              format: 'email',
              description: 'Email do usu√°rio'
            },
            createdAt: {
              type: 'string',
              format: 'date-time',
              description: 'Data de cria√ß√£o'
            }
          }
        },
        Error: {
          type: 'object',
          properties: {
            success: {
              type: 'boolean',
              example: false
            },
            message: {
              type: 'string',
              description: 'Mensagem de erro'
            },
            error: {
              type: 'string',
              description: 'Detalhes do erro'
            }
          }
        }
      }
    }
  },
  apis: ['./src/routes/*.js', './src/controllers/*.js']
};

const specs = swaggerJsdoc(options);

module.exports = { specs, swaggerUi };
```

#### **Documenta√ß√£o de Endpoints**
```javascript
// userController.js
/**
 * @swagger
 * /users:
 *   get:
 *     summary: Listar usu√°rios
 *     tags: [Users]
 *     parameters:
 *       - in: query
 *         name: page
 *         schema:
 *           type: integer
 *           default: 1
 *         description: N√∫mero da p√°gina
 *       - in: query
 *         name: limit
 *         schema:
 *           type: integer
 *           default: 10
 *         description: Limite de itens por p√°gina
 *     responses:
 *       200:
 *         description: Lista de usu√°rios
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                   example: true
 *                 data:
 *                   type: array
 *                   items:
 *                     $ref: '#/components/schemas/User'
 *                 pagination:
 *                   type: object
 *                   properties:
 *                     page:
 *                       type: integer
 *                     limit:
 *                       type: integer
 *                     total:
 *                       type: integer
 *       500:
 *         description: Erro interno do servidor
 *         content:
 *           application/json:
 *             schema:
 *               $ref: '#/components/schemas/Error'
 */
const getUsers = async (req, res) => {
  try {
    const { page = 1, limit = 10 } = req.query;
    const users = await userService.getUsers(page, limit);
    
    res.status(200).json({
      success: true,
      data: users.data,
      pagination: users.pagination
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      message: 'Erro interno do servidor',
      error: error.message
    });
  }
};

/**
 * @swagger
 * /users:
 *   post:
 *     summary: Criar novo usu√°rio
 *     tags: [Users]
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             required:
 *               - name
 *               - email
 *               - password
 *             properties:
 *               name:
 *                 type: string
 *                 description: Nome do usu√°rio
 *               email:
 *                 type: string
 *                 format: email
 *                 description: Email do usu√°rio
 *               password:
 *                 type: string
 *                 minLength: 6
 *                 description: Senha do usu√°rio
 *     responses:
 *       201:
 *         description: Usu√°rio criado com sucesso
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                   example: true
 *                 data:
 *                   $ref: '#/components/schemas/User'
 *                 message:
 *                   type: string
 *                   example: Usu√°rio criado com sucesso
 *       400:
 *         description: Dados inv√°lidos
 *         content:
 *           application/json:
 *             schema:
 *               $ref: '#/components/schemas/Error'
 */
const createUser = async (req, res) => {
  try {
    const { name, email, password } = req.body;
    const user = await userService.createUser({ name, email, password });
    
    res.status(201).json({
      success: true,
      data: user,
      message: 'Usu√°rio criado com sucesso'
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      message: 'Erro ao criar usu√°rio',
      error: error.message
    });
  }
};
```

### 6. üß™ Testes de APIs

#### **Testes com Supertest**
```bash
# Instala√ß√£o
npm install --save-dev supertest jest

# Configura√ß√£o
```

```javascript
// tests/integration/user.test.js
const request = require('supertest');
const app = require('../../src/app');
const userService = require('../../src/services/userService');

// Mock do servi√ßo
jest.mock('../../src/services/userService');

describe('User API', () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });
  
  describe('GET /api/v1/users', () => {
    test('should return list of users', async () => {
      const mockUsers = [
        { id: 1, name: 'Jo√£o', email: 'joao@exemplo.com' },
        { id: 2, name: 'Maria', email: 'maria@exemplo.com' }
      ];
      
      userService.getUsers.mockResolvedValue({
        data: mockUsers,
        pagination: { page: 1, limit: 10, total: 2 }
      });
      
      const response = await request(app)
        .get('/api/v1/users')
        .expect(200);
      
      expect(response.body.success).toBe(true);
      expect(response.body.data).toHaveLength(2);
      expect(response.body.pagination).toBeDefined();
    });
    
    test('should handle pagination', async () => {
      userService.getUsers.mockResolvedValue({
        data: [],
        pagination: { page: 2, limit: 5, total: 0 }
      });
      
      const response = await request(app)
        .get('/api/v1/users?page=2&limit=5')
        .expect(200);
      
      expect(response.body.pagination.page).toBe(2);
      expect(response.body.pagination.limit).toBe(5);
    });
  });
  
  describe('POST /api/v1/users', () => {
    test('should create new user', async () => {
      const newUser = {
        name: 'Jo√£o',
        email: 'joao@exemplo.com',
        password: 'senha123'
      };
      
      const createdUser = { id: 1, ...newUser };
      userService.createUser.mockResolvedValue(createdUser);
      
      const response = await request(app)
        .post('/api/v1/users')
        .send(newUser)
        .expect(201);
      
      expect(response.body.success).toBe(true);
      expect(response.body.data.name).toBe(newUser.name);
      expect(response.body.message).toBe('Usu√°rio criado com sucesso');
    });
    
    test('should return 400 for invalid data', async () => {
      const invalidUser = {
        name: 'Jo√£o'
        // missing email and password
      };
      
      const response = await request(app)
        .post('/api/v1/users')
        .send(invalidUser)
        .expect(400);
      
      expect(response.body.success).toBe(false);
      expect(response.body.message).toContain('obrigat√≥rios');
    });
  });
  
  describe('GET /api/v1/users/:id', () => {
    test('should return user by id', async () => {
      const mockUser = { id: 1, name: 'Jo√£o', email: 'joao@exemplo.com' };
      userService.getUserById.mockResolvedValue(mockUser);
      
      const response = await request(app)
        .get('/api/v1/users/1')
        .expect(200);
      
      expect(response.body.success).toBe(true);
      expect(response.body.data.id).toBe(1);
    });
    
    test('should return 404 for non-existent user', async () => {
      userService.getUserById.mockResolvedValue(null);
      
      const response = await request(app)
        .get('/api/v1/users/999')
        .expect(404);
      
      expect(response.body.success).toBe(false);
      expect(response.body.message).toBe('Usu√°rio n√£o encontrado');
    });
  });
});
```

### 7. üîß Middleware e Valida√ß√£o

#### **Middleware de Valida√ß√£o**
```javascript
// middleware/validation.js
const Joi = require('joi');

// Schema de valida√ß√£o para usu√°rio
const userSchema = Joi.object({
  name: Joi.string().min(2).max(50).required(),
  email: Joi.string().email().required(),
  password: Joi.string().min(6).required()
});

// Schema de valida√ß√£o para ID
const idSchema = Joi.object({
  id: Joi.number().integer().positive().required()
});

// Schema de valida√ß√£o para query parameters
const querySchema = Joi.object({
  page: Joi.number().integer().min(1).default(1),
  limit: Joi.number().integer().min(1).max(100).default(10),
  sort: Joi.string().valid('name', 'email', 'createdAt').default('name'),
  order: Joi.string().valid('asc', 'desc').default('asc')
});

// Middleware de valida√ß√£o
const validateUser = (req, res, next) => {
  const { error } = userSchema.validate(req.body);
  
  if (error) {
    return res.status(400).json({
      success: false,
      message: 'Dados inv√°lidos',
      errors: error.details.map(detail => detail.message)
    });
  }
  
  next();
};

const validateId = (req, res, next) => {
  const { error } = idSchema.validate({ id: req.params.id });
  
  if (error) {
    return res.status(400).json({
      success: false,
      message: 'ID inv√°lido',
      errors: error.details.map(detail => detail.message)
    });
  }
  
  next();
};

const validateQuery = (req, res, next) => {
  const { error } = querySchema.validate(req.query);
  
  if (error) {
    return res.status(400).json({
      success: false,
      message: 'Par√¢metros de query inv√°lidos',
      errors: error.details.map(detail => detail.message)
    });
  }
  
  next();
};

module.exports = {
  validateUser,
  validateId,
  validateQuery
};
```

#### **Middleware de Erro**
```javascript
// middleware/errorHandler.js
const errorHandler = (err, req, res, next) => {
  let error = { ...err };
  error.message = err.message;
  
  // Log do erro
  console.error(err);
  
  // Erro de valida√ß√£o do Mongoose
  if (err.name === 'ValidationError') {
    const message = Object.values(err.errors).map(val => val.message);
    error = {
      message: 'Dados inv√°lidos',
      errors: message
    };
    return res.status(400).json({
      success: false,
      ...error
    });
  }
  
  // Erro de duplica√ß√£o
  if (err.code === 11000) {
    const message = 'Recurso j√° existe';
    error = { message };
    return res.status(409).json({
      success: false,
      message
    });
  }
  
  // Erro de cast
  if (err.name === 'CastError') {
    const message = 'ID inv√°lido';
    error = { message };
    return res.status(400).json({
      success: false,
      message
    });
  }
  
  // Erro padr√£o
  res.status(error.statusCode || 500).json({
    success: false,
    message: error.message || 'Erro interno do servidor'
  });
};

module.exports = errorHandler;
```

### 8. üöÄ Boas Pr√°ticas

#### **Estrutura de Resposta**
```javascript
// utils/response.js
class ApiResponse {
  static success(data, message = 'Sucesso', statusCode = 200) {
    return {
      success: true,
      data,
      message,
      timestamp: new Date().toISOString()
    };
  }
  
  static error(message = 'Erro', statusCode = 500, errors = null) {
    return {
      success: false,
      message,
      errors,
      timestamp: new Date().toISOString()
    };
  }
  
  static paginated(data, pagination, message = 'Sucesso') {
    return {
      success: true,
      data,
      pagination,
      message,
      timestamp: new Date().toISOString()
    };
  }
}

// Uso nos controllers
const getUsers = async (req, res) => {
  try {
    const { page, limit } = req.query;
    const result = await userService.getUsers(page, limit);
    
    res.status(200).json(
      ApiResponse.paginated(result.data, result.pagination)
    );
  } catch (error) {
    res.status(500).json(
      ApiResponse.error('Erro interno do servidor', 500, error.message)
    );
  }
};
```

#### **Rate Limiting**
```javascript
// middleware/rateLimiter.js
const rateLimit = require('express-rate-limit');

// Rate limiter geral
const generalLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutos
  max: 100, // m√°ximo 100 requisi√ß√µes por IP
  message: {
    success: false,
    message: 'Muitas requisi√ß√µes, tente novamente em 15 minutos'
  },
  standardHeaders: true,
  legacyHeaders: false
});

// Rate limiter para autentica√ß√£o
const authLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutos
  max: 5, // m√°ximo 5 tentativas de login
  message: {
    success: false,
    message: 'Muitas tentativas de login, tente novamente em 15 minutos'
  },
  skipSuccessfulRequests: true
});

// Rate limiter para cria√ß√£o de recursos
const createLimiter = rateLimit({
  windowMs: 60 * 1000, // 1 minuto
  max: 10, // m√°ximo 10 cria√ß√µes por minuto
  message: {
    success: false,
    message: 'Muitas cria√ß√µes, tente novamente em 1 minuto'
  }
});

module.exports = {
  generalLimiter,
  authLimiter,
  createLimiter
};
```

---

## üß™ Exerc√≠cios Pr√°ticos

### **Exerc√≠cio 1: API REST B√°sica**
Implemente API REST completa:
- Criar estrutura de projeto
- Implementar CRUD de usu√°rios
- Configurar rotas e middleware
- Implementar valida√ß√£o

**Crit√©rios de avalia√ß√£o:**
- ‚úÖ Estrutura criada
- ‚úÖ CRUD implementado
- ‚úÖ Rotas configuradas
- ‚úÖ Valida√ß√£o implementada

### **Exerc√≠cio 2: Documenta√ß√£o OpenAPI**
Documente API com Swagger:
- Configurar Swagger
- Documentar endpoints
- Configurar schemas
- Testar documenta√ß√£o

**Crit√©rios de avalia√ß√£o:**
- ‚úÖ Swagger configurado
- ‚úÖ Endpoints documentados
- ‚úÖ Schemas configurados
- ‚úÖ Documenta√ß√£o testada

### **Exerc√≠cio 3: Testes de API**
Implemente testes completos:
- Configurar Supertest
- Implementar testes unit√°rios
- Implementar testes de integra√ß√£o
- Configurar coverage

**Crit√©rios de avalia√ß√£o:**
- ‚úÖ Supertest configurado
- ‚úÖ Testes unit√°rios
- ‚úÖ Testes de integra√ß√£o
- ‚úÖ Coverage configurado

### **Exerc√≠cio 4: Middleware e Seguran√ßa**
Implemente middleware avan√ßado:
- Configurar valida√ß√£o
- Implementar rate limiting
- Configurar error handling
- Implementar logging

**Crit√©rios de avalia√ß√£o:**
- ‚úÖ Valida√ß√£o configurada
- ‚úÖ Rate limiting implementado
- ‚úÖ Error handling configurado
- ‚úÖ Logging implementado

---

## üí° Dicas Importantes

### **1. Design de APIs**
- Use substantivos para recursos
- Implemente versionamento
- Documente tudo
- Mantenha consist√™ncia

### **2. Status Codes**
- Use c√≥digos apropriados
- Seja consistente
- Documente c√≥digos de erro
- Implemente tratamento adequado

### **3. Valida√ß√£o**
- Valide entrada sempre
- Use schemas consistentes
- Retorne erros claros
- Implemente sanitiza√ß√£o

### **4. Testes**
- Teste casos de sucesso e erro
- Use mocks adequadamente
- Implemente testes de integra√ß√£o
- Mantenha coverage alto

---

## üöÄ Pr√≥ximos Passos

Na pr√≥xima aula, voc√™ aprender√° sobre:
- Autentica√ß√£o e Autoriza√ß√£o
- JWT e tokens
- OAuth 2.0
- Middleware de seguran√ßa

---

## üìù Checklist de Conclus√£o

- [ ] Dominou arquitetura REST
- [ ] Implementou m√©todos HTTP corretos
- [ ] Designou endpoints eficientes
- [ ] Aplicou versionamento de APIs
- [ ] Documentou com OpenAPI
- [ ] Implementou testes de APIs
- [ ] Configurou middleware
- [ ] Aplicou boas pr√°ticas
- [ ] Completou os 4 exerc√≠cios
- [ ] Testou em diferentes cen√°rios

**üéâ Parab√©ns! Voc√™ completou a Aula 1 com sucesso!**

---

## üìö Recursos Adicionais

- [REST API Design](https://restfulapi.net/)
- [OpenAPI Specification](https://swagger.io/specification/)
- [HTTP Status Codes](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status)
- [API Design Best Practices](https://docs.microsoft.com/en-us/azure/architecture/best-practices/api-design)

---

*Pr√≥xima aula: Autentica√ß√£o e Autoriza√ß√£o*







