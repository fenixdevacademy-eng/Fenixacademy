#!/usr/bin/env python3
"""
Script de Teste para Todas as Funcionalidades da Fenix Academy
Verifica APIs de Execu√ß√£o de C√≥digo, Autentica√ß√£o e Recomenda√ß√µes
"""

import requests
import json
import time
import sys
from datetime import datetime
from typing import Dict, List, Any

# Configura√ß√µes das APIs
APIS = {
    "code_execution": {
        "base_url": "http://localhost:8001",
        "name": "üöÄ API de Execu√ß√£o de C√≥digo"
    },
    "authentication": {
        "base_url": "http://localhost:8002",
        "name": "üîê API de Autentica√ß√£o"
    },
    "recommendations": {
        "base_url": "http://localhost:8003",
        "name": "ü§ñ API de Recomenda√ß√µes"
    }
}

# Dados de teste
TEST_DATA = {
    "users": [
        {
            "email": "test_student@fenix.academy",
            "username": "test_student",
            "full_name": "Estudante Teste",
            "password": "test123456",
            "confirm_password": "test123456",
            "role": "student"
        },
        {
            "email": "test_instructor@fenix.academy",
            "username": "test_instructor",
            "full_name": "Instrutor Teste",
            "password": "test123456",
            "confirm_password": "test123456",
            "role": "instructor"
        }
    ],
    "code_samples": {
        "python": 'print("Hello, Fenix Academy!")',
        "javascript": 'console.log("Hello, Fenix Academy!");',
        "html": '<!DOCTYPE html><html><body><h1>Hello, Fenix Academy!</h1></body></html>'
    },
    "content_items": [
        {
            "item_id": "test_course_1",
            "title": "Python para Iniciantes",
            "category": "beginner",
            "difficulty": "beginner",
            "tags": ["python", "programming", "beginner"],
            "description": "Curso introdut√≥rio de Python",
            "content_type": "video",
            "duration": 60,
            "prerequisites": [],
            "popularity_score": 85.0,
            "rating": 4.5,
            "view_count": 100
        }
    ]
}

class FenixAcademyTester:
    def __init__(self):
        self.session = requests.Session()
        self.test_results = {}
        self.auth_tokens = {}
        
    def print_header(self, title: str):
        """Exibe cabe√ßalho de teste"""
        print("\n" + "=" * 60)
        print(f"üß™ TESTANDO: {title}")
        print("=" * 60)
    
    def print_result(self, test_name: str, success: bool, details: str = ""):
        """Exibe resultado de um teste"""
        status = "‚úÖ PASSOU" if success else "‚ùå FALHOU"
        print(f"   {status} {test_name}")
        if details and not success:
            print(f"      Detalhes: {details}")
    
    def test_api_health(self, api_name: str, base_url: str) -> bool:
        """Testa sa√∫de de uma API"""
        try:
            response = self.session.get(f"{base_url}/health", timeout=10)
            if response.status_code == 200:
                health_data = response.json()
                print(f"      Status: {health_data.get('status', 'N/A')}")
                return True
            else:
                return False
        except Exception as e:
            return False
    
    def test_code_execution_api(self) -> Dict[str, bool]:
        """Testa API de execu√ß√£o de c√≥digo"""
        self.print_header("API de Execu√ß√£o de C√≥digo")
        
        base_url = APIS["code_execution"]["base_url"]
        results = {}
        
        # Teste 1: Health check
        print("1. Verificando sa√∫de da API...")
        results["health"] = self.test_api_health("code_execution", base_url)
        self.print_result("Health Check", results["health"])
        
        # Teste 2: Listar linguagens suportadas
        print("2. Listando linguagens suportadas...")
        try:
            response = self.session.get(f"{base_url}/languages", timeout=10)
            if response.status_code == 200:
                languages = response.json()
                print(f"      Linguagens dispon√≠veis: {len(languages)}")
                for lang in languages[:3]:  # Mostrar primeiras 3
                    print(f"        ‚Ä¢ {lang.get('name', 'N/A')} ({lang.get('language', 'N/A')})")
                results["languages"] = True
            else:
                results["languages"] = False
        except Exception as e:
            results["languages"] = False
        self.print_result("Listar Linguagens", results["languages"])
        
        # Teste 3: Executar c√≥digo Python
        print("3. Executando c√≥digo Python...")
        try:
            code_data = {
                "code": TEST_DATA["code_samples"]["python"],
                "language": "python",
                "timeout": 30,
                "memory_limit": "512m",
                "user_id": "test_user"
            }
            response = self.session.post(f"{base_url}/execute", json=code_data, timeout=30)
            if response.status_code == 200:
                result = response.json()
                print(f"      Execu√ß√£o bem-sucedida: {result.get('success', False)}")
                print(f"      Output: {result.get('output', 'N/A')[:100]}...")
                results["python_execution"] = True
            else:
                results["python_execution"] = False
        except Exception as e:
            results["python_execution"] = False
        self.print_result("Execu√ß√£o Python", results["python_execution"])
        
        # Teste 4: Executar c√≥digo JavaScript
        print("4. Executando c√≥digo JavaScript...")
        try:
            code_data = {
                "code": TEST_DATA["code_samples"]["javascript"],
                "language": "javascript",
                "timeout": 30,
                "memory_limit": "512m",
                "user_id": "test_user"
            }
            response = self.session.post(f"{base_url}/execute", json=code_data, timeout=30)
            if response.status_code == 200:
                result = response.json()
                print(f"      Execu√ß√£o bem-sucedida: {result.get('success', False)}")
                results["javascript_execution"] = True
            else:
                results["javascript_execution"] = False
        except Exception as e:
            results["javascript_execution"] = False
        self.print_result("Execu√ß√£o JavaScript", results["javascript_execution"])
        
        # Teste 5: Estat√≠sticas
        print("5. Verificando estat√≠sticas...")
        try:
            response = self.session.get(f"{base_url}/stats", timeout=10)
            if response.status_code == 200:
                stats = response.json()
                print(f"      Total de execu√ß√µes: {stats.get('total_executions', 0)}")
                results["statistics"] = True
            else:
                results["statistics"] = False
        except Exception as e:
            results["statistics"] = False
        self.print_result("Estat√≠sticas", results["statistics"])
        
        return results
    
    def test_authentication_api(self) -> Dict[str, bool]:
        """Testa API de autentica√ß√£o"""
        self.print_header("API de Autentica√ß√£o")
        
        base_url = APIS["authentication"]["base_url"]
        results = {}
        
        # Teste 1: Health check
        print("1. Verificando sa√∫de da API...")
        results["health"] = self.test_api_health("authentication", base_url)
        self.print_result("Health Check", results["health"])
        
        # Teste 2: Registrar usu√°rio
        print("2. Registrando usu√°rio de teste...")
        try:
            user_data = TEST_DATA["users"][0]
            response = self.session.post(f"{base_url}/auth/register", json=user_data, timeout=10)
            if response.status_code == 200:
                user_info = response.json()
                print(f"      Usu√°rio criado: {user_info.get('username', 'N/A')}")
                results["user_registration"] = True
            else:
                results["user_registration"] = False
        except Exception as e:
            results["user_registration"] = False
        self.print_result("Registro de Usu√°rio", results["user_registration"])
        
        # Teste 3: Login
        print("3. Fazendo login...")
        try:
            login_data = {
                "email": TEST_DATA["users"][0]["email"],
                "password": TEST_DATA["users"][0]["password"]
            }
            response = self.session.post(f"{base_url}/auth/login", json=login_data, timeout=10)
            if response.status_code == 200:
                login_result = response.json()
                self.auth_tokens["student"] = login_result.get("access_token")
                print(f"      Login bem-sucedido para: {login_result.get('user', {}).get('username', 'N/A')}")
                results["user_login"] = True
            else:
                results["user_login"] = False
        except Exception as e:
            results["user_login"] = False
        self.print_result("Login de Usu√°rio", results["user_login"])
        
        # Teste 4: Obter perfil do usu√°rio
        print("4. Obtendo perfil do usu√°rio...")
        try:
            headers = {"Authorization": f"Bearer {self.auth_tokens.get('student', '')}"}
            response = self.session.get(f"{base_url}/users/me", headers=headers, timeout=10)
            if response.status_code == 200:
                profile = response.json()
                print(f"      Perfil obtido: {profile.get('username', 'N/A')}")
                results["get_profile"] = True
            else:
                results["get_profile"] = False
        except Exception as e:
            results["get_profile"] = False
        self.print_result("Obter Perfil", results["get_profile"])
        
        # Teste 5: Criar projeto
        print("5. Criando projeto colaborativo...")
        try:
            project_data = {
                "name": "Projeto Teste Fenix",
                "description": "Projeto de teste para valida√ß√£o da plataforma",
                "course_id": "test_course_1",
                "max_members": 5,
                "is_public": True
            }
            headers = {"Authorization": f"Bearer {self.auth_tokens.get('student', '')}"}
            response = self.session.post(f"{base_url}/projects", json=project_data, headers=headers, timeout=10)
            if response.status_code == 200:
                project = response.json()
                print(f"      Projeto criado: {project.get('name', 'N/A')}")
                results["create_project"] = True
            else:
                results["create_project"] = False
        except Exception as e:
            results["create_project"] = False
        self.print_result("Criar Projeto", results["create_project"])
        
        return results
    
    def test_recommendations_api(self) -> Dict[str, bool]:
        """Testa API de recomenda√ß√µes"""
        self.print_header("API de Recomenda√ß√µes")
        
        base_url = APIS["recommendations"]["base_url"]
        results = {}
        
        # Teste 1: Health check
        print("1. Verificando sa√∫de da API...")
        results["health"] = self.test_api_health("recommendations", base_url)
        self.print_result("Health Check", results["health"])
        
        # Teste 2: Criar perfil de usu√°rio
        print("2. Criando perfil de usu√°rio para recomenda√ß√µes...")
        try:
            user_profile = {
                "user_id": "test_user_rec",
                "interests": ["python", "machine-learning", "data-science"],
                "skill_level": "intermediate",
                "preferred_categories": ["practical", "project_based"],
                "learning_goals": ["master-ml", "build-portfolio"],
                "time_availability": "evening",
                "preferred_format": "video"
            }
            response = self.session.post(f"{base_url}/users", json=user_profile, timeout=10)
            if response.status_code == 200:
                print(f"      Perfil criado: {user_profile['user_id']}")
                results["create_user_profile"] = True
            else:
                results["create_user_profile"] = False
        except Exception as e:
            results["create_user_profile"] = False
        self.print_result("Criar Perfil de Usu√°rio", results["create_user_profile"])
        
        # Teste 3: Adicionar conte√∫do
        print("3. Adicionando conte√∫do para recomenda√ß√µes...")
        try:
            content_item = TEST_DATA["content_items"][0]
            response = self.session.post(f"{base_url}/content", json=content_item, timeout=10)
            if response.status_code == 200:
                print(f"      Conte√∫do adicionado: {content_item['title']}")
                results["add_content"] = True
            else:
                results["add_content"] = False
        except Exception as e:
            results["add_content"] = False
        self.print_result("Adicionar Conte√∫do", results["add_content"])
        
        # Teste 4: Registrar intera√ß√£o
        print("4. Registrando intera√ß√£o do usu√°rio...")
        try:
            interaction = {
                "user_id": "test_user_rec",
                "item_id": "test_course_1",
                "interaction_type": "course_view",
                "duration": 45,
                "score": 85.0,
                "rating": 4
            }
            response = self.session.post(f"{base_url}/interactions", json=interaction, timeout=10)
            if response.status_code == 200:
                print(f"      Intera√ß√£o registrada: {interaction['interaction_type']}")
                results["register_interaction"] = True
            else:
                results["register_interaction"] = False
        except Exception as e:
            results["register_interaction"] = False
        self.print_result("Registrar Intera√ß√£o", results["register_interaction"])
        
        # Teste 5: Gerar recomenda√ß√µes
        print("5. Gerando recomenda√ß√µes personalizadas...")
        try:
            recommendation_request = {
                "user_id": "test_user_rec",
                "n_recommendations": 5
            }
            response = self.session.post(f"{base_url}/recommendations", json=recommendation_request, timeout=10)
            if response.status_code == 200:
                recommendations = response.json()
                print(f"      Recomenda√ß√µes geradas: {recommendations.get('total_count', 0)}")
                results["generate_recommendations"] = True
            else:
                results["generate_recommendations"] = False
        except Exception as e:
            results["generate_recommendations"] = False
        self.print_result("Gerar Recomenda√ß√µes", results["generate_recommendations"])
        
        # Teste 6: Treinar modelos
        print("6. Iniciando treinamento dos modelos...")
        try:
            training_request = {
                "model_types": ["all"],
                "force_retrain": False
            }
            response = self.session.post(f"{base_url}/training", json=training_request, timeout=10)
            if response.status_code == 200:
                training = response.json()
                print(f"      Treinamento iniciado: {training.get('status', 'N/A')}")
                results["start_training"] = True
            else:
                results["start_training"] = False
        except Exception as e:
            results["start_training"] = False
        self.print_result("Iniciar Treinamento", results["start_training"])
        
        return results
    
    def run_all_tests(self) -> Dict[str, Dict[str, bool]]:
        """Executa todos os testes"""
        print("üöÄ FENIX ACADEMY - TESTE COMPLETO DE FUNCIONALIDADES")
        print("=" * 60)
        print(f"‚è∞ Iniciado em: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        print()
        
        # Testar API de execu√ß√£o de c√≥digo
        self.test_results["code_execution"] = self.test_code_execution_api()
        
        # Testar API de autentica√ß√£o
        self.test_results["authentication"] = self.test_authentication_api()
        
        # Testar API de recomenda√ß√µes
        self.test_results["recommendations"] = self.test_recommendations_api()
        
        return self.test_results
    
    def print_summary(self):
        """Exibe resumo dos testes"""
        print("\n" + "=" * 60)
        print("üìä RESUMO DOS TESTES")
        print("=" * 60)
        
        total_tests = 0
        passed_tests = 0
        
        for api_name, results in self.test_results.items():
            api_display_name = APIS[api_name]["name"]
            print(f"\n{api_display_name}:")
            
            api_total = len(results)
            api_passed = sum(1 for result in results.values() if result)
            
            total_tests += api_total
            passed_tests += api_passed
            
            for test_name, success in results.items():
                status = "‚úÖ" if success else "‚ùå"
                print(f"   {status} {test_name}")
            
            print(f"   üìà Resultado: {api_passed}/{api_total} testes passaram")
        
        print(f"\nüéØ RESULTADO GERAL: {passed_tests}/{total_tests} testes passaram")
        
        if passed_tests == total_tests:
            print("üéâ TODOS OS TESTES PASSARAM! A plataforma est√° funcionando perfeitamente!")
        elif passed_tests > total_tests * 0.8:
            print("‚ö†Ô∏è  A maioria dos testes passou. Verifique os que falharam.")
        else:
            print("‚ùå Muitos testes falharam. Verifique a configura√ß√£o das APIs.")
        
        success_rate = (passed_tests / total_tests * 100) if total_tests > 0 else 0
        print(f"üìä Taxa de Sucesso: {success_rate:.1f}%")

def main():
    """Fun√ß√£o principal"""
    print("üîç Iniciando testes da Fenix Academy...")
    
    # Verificar se as APIs est√£o rodando
    print("üîç Verificando se as APIs est√£o rodando...")
    
    for api_name, config in APIS.items():
        try:
            response = requests.get(f"{config['base_url']}/", timeout=5)
            if response.status_code == 200:
                print(f"‚úÖ {config['name']} est√° rodando em {config['base_url']}")
            else:
                print(f"‚ùå {config['name']} n√£o est√° respondendo corretamente")
        except requests.exceptions.RequestException:
            print(f"‚ùå {config['name']} n√£o est√° acess√≠vel em {config['base_url']}")
            print("üí° Certifique-se de que todas as APIs est√£o rodando:")
            print("   python start_apis.py")
            return
    
    print("\nüöÄ Todas as APIs est√£o rodando! Iniciando testes...")
    
    # Executar testes
    tester = FenixAcademyTester()
    results = tester.run_all_tests()
    
    # Exibir resumo
    tester.print_summary()
    
    # Retornar c√≥digo de sa√≠da apropriado
    total_tests = sum(len(api_results) for api_results in results.values())
    passed_tests = sum(
        sum(1 for result in api_results.values() if result)
        for api_results in results.values()
    )
    
    if passed_tests == total_tests:
        print("\nüéâ SUCESSO TOTAL! Todas as funcionalidades est√£o funcionando!")
        sys.exit(0)
    else:
        print(f"\n‚ö†Ô∏è  {total_tests - passed_tests} testes falharam. Verifique os logs acima.")
        sys.exit(1)

if __name__ == "__main__":
    main()
