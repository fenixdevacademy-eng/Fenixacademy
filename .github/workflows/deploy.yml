name: ðŸš€ Deploy Fenix Academy

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  # ðŸ” AnÃ¡lise de CÃ³digo
  analyze:
    name: ðŸ” AnÃ¡lise de CÃ³digo
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ðŸ“¦ Install Dependencies
        run: |
          cd frontend
          npm ci

      - name: ðŸ” ESLint
        run: |
          cd frontend
          npm run lint

      - name: ðŸŽ¨ Prettier Check
        run: |
          cd frontend
          npm run format:check

      - name: ðŸ”’ Security Audit
        run: |
          cd frontend
          npm audit --audit-level=moderate

  # ðŸ§ª Testes
  test:
    name: ðŸ§ª Testes
    runs-on: ubuntu-latest
    needs: analyze
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ðŸ“¦ Install Dependencies
        run: |
          cd frontend
          npm ci

      - name: ðŸ§ª Run Tests
        run: |
          cd frontend
          npm run test:ci

      - name: ðŸ“Š Coverage Report
        run: |
          cd frontend
          npm run test:coverage

      - name: ðŸ“ˆ Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          file: frontend/coverage/lcov.info
          flags: frontend
          name: fenix-academy-frontend

  # ðŸ—ï¸ Build
  build:
    name: ðŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: [analyze, test]
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ðŸ“¦ Install Dependencies
        run: |
          cd frontend
          npm ci

      - name: ðŸ—ï¸ Build Application
        run: |
          cd frontend
          npm run build

      - name: ðŸ“Š Build Analysis
        run: |
          cd frontend
          npm run analyze

      - name: ðŸ’¾ Upload Build Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-files
          path: frontend/.next/
          retention-days: 7

  # ðŸš€ Deploy to Staging
  deploy-staging:
    name: ðŸš€ Deploy Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop'
    environment: staging
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ðŸ“¦ Install Dependencies
        run: |
          cd frontend
          npm ci

      - name: ðŸš€ Deploy to Vercel (Staging)
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: frontend

      - name: ðŸ” Health Check Staging
        run: |
          sleep 30
          curl -f https://fenix-academy-staging.vercel.app/health || exit 1

      - name: ðŸ“Š Performance Test Staging
        run: |
          npx lighthouse https://fenix-academy-staging.vercel.app --output=json --output-path=./lighthouse-staging.json --chrome-flags="--headless"

      - name: ðŸ“ˆ Upload Performance Report
        uses: actions/upload-artifact@v3
        with:
          name: lighthouse-staging-report
          path: lighthouse-staging.json

  # ðŸš€ Deploy to Production
  deploy-production:
    name: ðŸš€ Deploy Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ðŸ“¦ Install Dependencies
        run: |
          cd frontend
          npm ci

      - name: ðŸš€ Deploy to Vercel (Production)
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: frontend

      - name: ðŸ” Health Check Production
        run: |
          sleep 30
          curl -f https://fenix-academy.com/health || exit 1

      - name: ðŸ“Š Performance Test Production
        run: |
          npx lighthouse https://fenix-academy.com --output=json --output-path=./lighthouse-production.json --chrome-flags="--headless"

      - name: ðŸ“ˆ Upload Performance Report
        uses: actions/upload-artifact@v3
        with:
          name: lighthouse-production-report
          path: lighthouse-production.json

      - name: ðŸŒ CDN Invalidation
        run: |
          # Invalidate CloudFront cache
          aws cloudfront create-invalidation --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} --paths "/*"

      - name: ðŸ“± Mobile Test
        run: |
          npx lighthouse https://fenix-academy.com --output=json --output-path=./lighthouse-mobile.json --chrome-flags="--headless" --form-factor=mobile

      - name: ðŸ“ˆ Upload Mobile Performance Report
        uses: actions/upload-artifact@v3
        with:
          name: lighthouse-mobile-report
          path: lighthouse-mobile.json

  # ðŸ”” Notifications
  notify:
    name: ðŸ”” Notifications
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always()
    steps:
      - name: ðŸ“± Slack Notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
        if: always()

      - name: ðŸ“§ Email Notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "Fenix Academy Deploy - ${{ github.ref_name }}"
          to: admin@fenix-academy.com
          from: GitHub Actions
          body: |
            Deploy Status: ${{ job.status }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            Workflow: ${{ github.workflow }}
        if: always()

  # ðŸ§¹ Cleanup
  cleanup:
    name: ðŸ§¹ Cleanup
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always()
    steps:
      - name: ðŸ—‘ï¸ Delete Old Artifacts
        uses: actions/github-script@v6
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
            });
            
            const oldArtifacts = artifacts.data.artifacts.filter(artifact => {
              const createdAt = new Date(artifact.created_at);
              const now = new Date();
              const daysDiff = (now - createdAt) / (1000 * 60 * 60 * 24);
              return daysDiff > 7;
            });
            
            for (const artifact of oldArtifacts) {
              await github.rest.actions.deleteArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: artifact.id,
              });
            }