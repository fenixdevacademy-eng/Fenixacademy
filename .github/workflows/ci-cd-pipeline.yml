name: ğŸ”¥ Fenix Academy CI/CD Pipeline

on:
  push:
    branches: [main, develop, feature/*, bugfix/*, hotfix/*]
  pull_request:
    branches: [main, develop]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  PYTHON_VERSION: '3.9'
  NODE_VERSION: '18'
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: fenix-academy

jobs:
  # ========================================
  # ğŸ”’ AUDITORIA DE SEGURANÃ‡A
  # ========================================
  security-audit:
    name: ğŸ”’ Auditoria de SeguranÃ§a
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt

      - name: ğŸ” Run security audit
        run: |
          cd backend
          python -m security.security_audit

      - name: ğŸ“Š Security report
        if: always()
        run: |
          echo "ğŸ”’ RelatÃ³rio de SeguranÃ§a Gerado"
          echo "Verificar logs acima para detalhes"

  # ========================================
  # ğŸ§ª TESTES AUTOMATIZADOS
  # ========================================
  test-backend:
    name: ğŸ§ª Testes Backend
    runs-on: ubuntu-latest
    needs: security-audit
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
        database: ['postgresql', 'sqlite']
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: fenix_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:6-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install pytest pytest-asyncio pytest-cov pytest-mock

      - name: ğŸ”§ Setup test environment
        run: |
          cd backend
          echo "DATABASE_URL=postgresql://postgres:postgres@localhost:5432/fenix_test" > .env.test
          echo "REDIS_URL=redis://localhost:6379" >> .env.test
          echo "JWT_SECRET=test-secret-key" >> .env.test

      - name: ğŸ—„ï¸ Setup database
        if: matrix.database == 'postgresql'
        run: |
          cd backend
          python -c "
          import psycopg2
          conn = psycopg2.connect(
              host='localhost',
              database='postgres',
              user='postgres',
              password='postgres'
          )
          conn.autocommit = True
          cur = conn.cursor()
          cur.execute('CREATE DATABASE fenix_test')
          cur.close()
          conn.close()
          "

      - name: ğŸ§ª Run tests
        run: |
          cd backend
          pytest tests/ -v --cov=app --cov-report=xml --cov-report=html

      - name: ğŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./backend/coverage.xml
          flags: backend
          name: backend-coverage

  test-frontend:
    name: ğŸ§ª Testes Frontend
    runs-on: ubuntu-latest
    needs: security-audit
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ğŸ“¦ Install dependencies
        run: |
          cd frontend
          npm ci

      - name: ğŸ” Lint code
        run: |
          cd frontend
          npm run lint

      - name: ğŸ§ª Run tests
        run: |
          cd frontend
          npm run test:ci

      - name: ğŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./frontend/coverage/lcov.info
          flags: frontend
          name: frontend-coverage

  # ========================================
  # ğŸ“Š ANÃLISE DE QUALIDADE
  # ========================================
  code-quality:
    name: ğŸ“Š AnÃ¡lise de Qualidade
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install Python dependencies
        run: |
          pip install flake8 black isort mypy bandit safety

      - name: ğŸ” Python linting
        run: |
          cd backend
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=88 --statistics

      - name: ğŸ¨ Python formatting check
        run: |
          cd backend
          black --check --diff .
          isort --check-only --diff .

      - name: ğŸ”’ Python security check
        run: |
          cd backend
          bandit -r . -f json -o bandit-report.json || true
          safety check --json --output safety-report.json || true

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Install Node.js dependencies
        run: |
          cd frontend
          npm ci

      - name: ğŸ” Node.js linting
        run: |
          cd frontend
          npm run lint:check

      - name: ğŸ“Š Upload quality reports
        uses: actions/upload-artifact@v3
        with:
          name: quality-reports
          path: |
            backend/bandit-report.json
            backend/safety-report.json

  # ========================================
  # ğŸš€ BUILD E DOCKER
  # ========================================
  build:
    name: ğŸš€ Build e Docker
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend, code-quality]
    outputs:
      backend-image: ${{ steps.backend-build.outputs.image }}
      frontend-image: ${{ steps.frontend-build.outputs.image }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Build Backend
        id: backend-build
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ github.repository }}/backend:${{ github.sha }}
            ${{ env.DOCKER_REGISTRY }}/${{ github.repository }}/backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker,dest=backend-image.tar

      - name: ğŸ—ï¸ Build Frontend
        id: frontend-build
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ github.repository }}/frontend:${{ github.sha }}
            ${{ env.DOCKER_REGISTRY }}/${{ github.repository }}/frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker,dest=frontend-image.tar

      - name: ğŸ“¦ Save images
        run: |
          docker load --input backend-image.tar
          docker load --input frontend-image.tar

  # ========================================
  # ğŸ§ª TESTES DE INTEGRAÃ‡ÃƒO
  # ========================================
  integration-tests:
    name: ğŸ§ª Testes de IntegraÃ§Ã£o
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install pytest pytest-asyncio httpx docker-compose

      - name: ğŸš€ Start services
        run: |
          cd backend
          docker-compose -f docker-compose.test.yml up -d

      - name: â³ Wait for services
        run: |
          sleep 30
          curl -f http://localhost:8000/health || exit 1

      - name: ğŸ§ª Run integration tests
        run: |
          cd backend
          pytest tests/integration/ -v

      - name: ğŸ›‘ Stop services
        if: always()
        run: |
          cd backend
          docker-compose -f docker-compose.test.yml down

  # ========================================
  # ğŸ“Š TESTES DE PERFORMANCE
  # ========================================
  performance-tests:
    name: ğŸ“Š Testes de Performance
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install locust

      - name: ğŸš€ Start services
        run: |
          cd backend
          docker-compose -f docker-compose.test.yml up -d

      - name: â³ Wait for services
        run: |
          sleep 30
          curl -f http://localhost:8000/health || exit 1

      - name: ğŸ“Š Run performance tests
        run: |
          cd backend
          locust -f tests/performance/locustfile.py --host=http://localhost:8000 --headless --users=10 --spawn-rate=2 --run-time=60s

      - name: ğŸ›‘ Stop services
        if: always()
        run: |
          cd backend
          docker-compose -f docker-compose.test.yml down

  # ========================================
  # ğŸš€ DEPLOY STAGING
  # ========================================
  deploy-staging:
    name: ğŸš€ Deploy Staging
    runs-on: ubuntu-latest
    needs: [build, integration-tests, performance-tests]
    environment: staging
    if: github.ref == 'refs/heads/develop'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: ğŸš€ Deploy to staging
        run: |
          echo "ğŸš€ Deploying to staging environment..."
          # Comandos de deploy para staging
          # kubectl apply -f k8s/staging/
          # ou
          # aws eks update-kubeconfig --name fenix-staging-cluster
          # helm upgrade --install fenix-staging ./helm/fenix

      - name: âœ… Health check staging
        run: |
          echo "ğŸ” Checking staging deployment health..."
          # curl -f https://staging.fenix.academy/health || exit 1

      - name: ğŸ“§ Notify staging deployment
        run: |
          echo "ğŸ“§ Staging deployment completed successfully!"

  # ========================================
  # ğŸš€ DEPLOY PRODUÃ‡ÃƒO
  # ========================================
  deploy-production:
    name: ğŸš€ Deploy ProduÃ§Ã£o
    runs-on: ubuntu-latest
    needs: [build, integration-tests, performance-tests]
    environment: production
    if: github.ref == 'refs/heads/main' || github.event_name == 'release'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: ğŸš€ Deploy to production
        run: |
          echo "ğŸš€ Deploying to production environment..."
          # Comandos de deploy para produÃ§Ã£o
          # kubectl apply -f k8s/production/
          # ou
          # aws eks update-kubeconfig --name fenix-production-cluster
          # helm upgrade --install fenix-production ./helm/fenix

      - name: âœ… Health check production
        run: |
          echo "ğŸ” Checking production deployment health..."
          # curl -f https://fenix.academy/health || exit 1

      - name: ğŸ“§ Notify production deployment
        run: |
          echo "ğŸ“§ Production deployment completed successfully!"

      - name: ğŸ·ï¸ Tag release
        if: github.event_name == 'release'
        run: |
          git tag -a "v${{ github.event.release.tag_name }}" -m "Release ${{ github.event.release.tag_name }}"
          git push origin "v${{ github.event.release.tag_name }}"

  # ========================================
  # ğŸ“Š MONITORAMENTO PÃ“S-DEPLOY
  # ========================================
  post-deploy-monitoring:
    name: ğŸ“Š Monitoramento PÃ³s-Deploy
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always() && (needs.deploy-staging.result == 'success' || needs.deploy-production.result == 'success')
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“Š Run post-deploy tests
        run: |
          echo "ğŸ” Running post-deploy monitoring tests..."
          # Testes de smoke
          # curl -f https://fenix.academy/health
          # curl -f https://fenix.academy/api/v1/courses
          # curl -f https://fenix.academy/security/audit

      - name: ğŸ“ˆ Generate deployment report
        run: |
          echo "ğŸ“Š Generating deployment report..."
          # Gerar relatÃ³rio de deploy
          # Incluir mÃ©tricas de performance
          # Verificar logs de erro

  # ========================================
  # ğŸ”„ ROLLBACK (EMERGÃŠNCIA)
  # ========================================
  rollback:
    name: ğŸ”„ Rollback de EmergÃªncia
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always() && (needs.deploy-staging.result == 'failure' || needs.deploy-production.result == 'failure')
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: ğŸ”„ Execute rollback
        run: |
          echo "ğŸ”„ Executing emergency rollback..."
          # Comandos de rollback
          # kubectl rollout undo deployment/fenix
          # ou
          # helm rollback fenix

      - name: ğŸ“§ Notify rollback
        run: |
          echo "ğŸ“§ Emergency rollback completed!"

  # ========================================
  # ğŸ“Š RELATÃ“RIO FINAL
  # ========================================
  final-report:
    name: ğŸ“Š RelatÃ³rio Final
    runs-on: ubuntu-latest
    needs: [security-audit, test-backend, test-frontend, code-quality, build, integration-tests, performance-tests, deploy-staging, deploy-production, post-deploy-monitoring]
    if: always()
    steps:
      - name: ğŸ“Š Generate final report
        run: |
          echo "ğŸ“Š Generating final CI/CD pipeline report..."
          echo "ğŸ”’ Security Audit: ${{ needs.security-audit.result }}"
          echo "ğŸ§ª Backend Tests: ${{ needs.test-backend.result }}"
          echo "ğŸ§ª Frontend Tests: ${{ needs.test-frontend.result }}"
          echo "ğŸ“Š Code Quality: ${{ needs.code-quality.result }}"
          echo "ğŸš€ Build: ${{ needs.build.result }}"
          echo "ğŸ§ª Integration Tests: ${{ needs.integration-tests.result }}"
          echo "ğŸ“Š Performance Tests: ${{ needs.performance-tests.result }}"
          echo "ğŸš€ Staging Deploy: ${{ needs.deploy-staging.result }}"
          echo "ğŸš€ Production Deploy: ${{ needs.deploy-production.result }}"
          echo "ğŸ“Š Post-Deploy Monitoring: ${{ needs.post-deploy-monitoring.result }}"

      - name: ğŸ“§ Send notification
        if: always()
        run: |
          echo "ğŸ“§ Sending pipeline completion notification..."
          # Enviar notificaÃ§Ã£o via Slack, email, etc.

      - name: ğŸ“ˆ Update metrics
        if: always()
        run: |
          echo "ğŸ“ˆ Updating deployment metrics..."
          # Atualizar mÃ©tricas de deploy
          # Registrar tempo de execuÃ§Ã£o
          # Atualizar dashboard
